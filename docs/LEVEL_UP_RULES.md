# 升級規則說明

## 一、經驗值系統

### 1.1 經驗值獲取
- 戰鬥勝利後獲得經驗值
- 經驗值 = 所有被擊倒敵人的經驗值總和
- 菁英戰：經驗值 +30%
- 魔王戰：經驗值 +60%

### 1.2 升級所需經驗值
- **初始經驗值需求**：10 EXP（Lv 1 → Lv 2）
- **經驗值成長公式**：每升一級，下一級所需經驗值 × 1.3（增加30%）
- **連續升級**：如果經驗值足夠，可以連續升級多級

### 1.3 經驗值計算範例
- Lv 1 → Lv 2：10 EXP
- Lv 2 → Lv 3：13 EXP（10 × 1.3）
- Lv 3 → Lv 4：17 EXP（13 × 1.3，四捨五入）
- Lv 4 → Lv 5：22 EXP（17 × 1.3，四捨五入）
- ...以此類推

---

## 二、勇者升級規則

### 2.1 HP/MP 成長

#### HP 成長公式
- **基礎成長**：2 HP
- **額外成長**：隨機 0 ~ (體力值 ÷ 7)（向上取整）
- **總成長**：2 + 隨機值（整數）

**範例**：
- 體力值 14：HP 成長 = 2 + 隨機(0~2) = 2~4 HP
- 體力值 35：HP 成長 = 2 + 隨機(0~5) = 2~7 HP

#### MP 成長公式
- **基礎成長**：1 MP
- **額外成長**：隨機 0 ~ ((恢復力 + 魔力) ÷ 15)（向上取整）
- **總成長**：1 + 隨機值（整數）

**範例**：
- 恢復力 10 + 魔力 20 = 30：MP 成長 = 1 + 隨機(0~2) = 1~3 MP
- 恢復力 30 + 魔力 50 = 80：MP 成長 = 1 + 隨機(0~6) = 1~7 MP

#### 升級時的 HP/MP 處理
- **HP**：只增加最大HP，**不恢復當前HP**
- **MP**：只增加新增的MP數量（例如新增3 MP，當前MP就+3）

### 2.2 屬性成長

#### 基礎屬性成長
- **每項屬性**：隨機 +1 ~ (3 + 等級÷10)（向上取整）
- **可配置範圍**：
  - 最小值：`heroGrowthMin`（預設 1）
  - 最大值：`heroGrowthMax`（預設 2.5）+ 等級÷10

**範例**：
- Lv 1：每項屬性 +1 ~ 3
- Lv 10：每項屬性 +1 ~ 4（3 + 10÷10 = 4）
- Lv 20：每項屬性 +1 ~ 5（3 + 20÷10 = 5）
- Lv 50：每項屬性 +1 ~ 8（3 + 50÷10 = 8）

#### 職業類型額外加成
根據選擇的職業類型，每次升級會額外增加特定屬性：

- **攻擊型 (attacker)**：攻擊 +1、敏捷 +1
- **魔法型 (mage)**：魔力 +1、恢復力 +1
- **回復型 (healer)**：恢復力 +1、防禦 +1
- **防守型 (defender)**：防禦 +1、體力 +1
- **敏捷型 (agile)**：敏捷 +1、攻擊 +0.5

### 2.3 技能獲得

#### 技能獲得時機
- **每兩級獲得一次技能**（Lv 2, 4, 6, 8, 10, 12, ...）
- **特殊技能**：
  - Lv 20：自動習得「復活術」（復活同伴）

#### 技能選擇規則
- **總共 4 個選項**（三選一改為四選一）
- **至少包含**：
  - 1 個主動技能
  - 1 個被動技能
- **流派權重**：
  - 初始流派（根據職業類型）：5.0 倍權重
  - 其他流派：1.0 倍權重
  - 主要流派（已學技能最多的流派）：60% 機率
  - 其他流派：40% 機率（共享）

#### 技能選擇模式
- **戰鬥後升級**：總是手動選擇（四選一）
- **初始自動升級**：可設定自動選擇（在設定中開啟）

---

## 三、同伴升級規則

### 3.1 等級同步
- **同伴等級自動跟隨勇者等級**
- 當勇者升級時，所有同伴同步升級相同等級數

### 3.2 HP/MP 成長
- **公式與勇者相同**：
  - HP：2 + 隨機(0 ~ 體力值÷7)
  - MP：1 + 隨機(0 ~ (恢復力+魔力)÷15)

### 3.3 屬性成長
- **每項屬性**：隨機 +0 ~ (2 + 等級÷10)（向上取整）
- **可配置範圍**：
  - 最小值：`companionGrowthMin`（預設 0.3）
  - 最大值：`companionGrowthMax`（預設 2.0）+ 等級÷10

**範例**：
- Lv 1：每項屬性 +0 ~ 2
- Lv 10：每項屬性 +0 ~ 3（2 + 10÷10 = 3）
- Lv 20：每項屬性 +0 ~ 4（2 + 20÷10 = 4）

#### 職業類型額外加成
根據同伴的職業類型，每次升級會額外增加特定屬性（每個職業不同）

#### 個性修正
- 根據同伴的個性，每級會額外修正屬性
- 修正值 = 個性修正值 ÷ 2（減半）
- 保持小數點，不四捨五入

### 3.4 技能獲得

#### 技能獲得時機
- **每三級獲得一次技能**（Lv 3, 6, 9, 12, 15, ...）
- **特殊技能**：
  - Lv 10：自動習得「其他職業的主動技能」（隨機）
  - Lv 20：自動習得「其他職業的被動技能」（隨機）
  - Lv 30：將 Lv 10 獲得的技能升級（tier 1 → tier 2）
  - Lv 40：將 Lv 20 獲得的技能升級（tier 1 → tier 2）
  - Lv 50：將 Lv 10 獲得的技能再升級（tier 2 → tier 3）
  - Lv 60：將 Lv 40 升級的技能再升級（tier 2 → tier 3）

#### 技能選擇
- **自動選擇**：同伴技能由系統自動選擇（不手動選擇）
- **優先選擇本職業技能**

---

## 四、升級流程

### 4.1 戰鬥後升級流程
1. **獲得經驗值** → 檢查是否達到升級條件
2. **顯示能力提升畫面**：
   - 顯示等級變化
   - 顯示 HP/MP 成長
   - 顯示屬性成長
3. **技能選擇**（如果是偶數等級）：
   - 顯示 4 個技能選項
   - 玩家手動選擇一個
4. **同伴升級信息**（如果有同伴升級）：
   - 顯示同伴升級信息
   - 顯示同伴獲得的技能（如果有）

### 4.2 初始自動升級
- 在遊戲開始時，可以設定自動升級到目標等級
- 自動升級時：
  - 技能可以設定自動選擇（在設定中開啟）
  - 所有升級過程自動完成

---

## 五、配置參數

### 5.1 成長配置（可在 config.js 中調整）
```javascript
heroGrowthMin: 1,        // 勇者每等級屬性成長最小值
heroGrowthMax: 2.5,      // 勇者每等級屬性成長最大值（基礎值）
companionGrowthMin: 0.3, // 同伴每等級屬性成長最小值
companionGrowthMax: 2.0, // 同伴每等級屬性成長最大值（基礎值）
```

### 5.2 目標等級配置
```javascript
defaultTargetLevel: 50,  // 預設目標等級（初始自動升級）
```

---

## 六、升級注意事項

1. **連續升級**：如果經驗值足夠，可以一次升多級
2. **HP 不恢復**：升級時只增加最大HP，不恢復當前HP
3. **MP 部分恢復**：升級時只增加新增的MP數量
4. **技能選擇**：戰鬥後的升級總是手動選擇，初始自動升級可設定自動選擇
5. **同伴同步**：同伴等級始終跟隨勇者等級

---

## 七、升級範例

### 範例 1：勇者從 Lv 5 升到 Lv 6
- **經驗值需求**：約 37 EXP
- **HP 成長**：2 + 隨機(0 ~ 體力值÷7)
- **MP 成長**：1 + 隨機(0 ~ (恢復力+魔力)÷15)
- **屬性成長**：每項 +1 ~ 4（3 + 6÷10 = 3.6，向上取整 = 4）
- **職業加成**：根據職業類型額外加成
- **技能獲得**：是（Lv 6 是偶數等級）

### 範例 2：同伴從 Lv 10 升到 Lv 12（連升 2 級）
- **等級同步**：跟隨勇者升級
- **HP/MP 成長**：每級分別計算
- **屬性成長**：每級每項 +0 ~ 3（2 + 10÷10 = 3）
- **技能獲得**：Lv 12 時獲得技能（12 是 3 的倍數）

---

## 八、特殊升級事件

### 8.1 勇者特殊技能
- **Lv 20**：自動習得「復活術」（復活同伴）

### 8.2 同伴特殊技能
- **Lv 10**：其他職業主動技能
- **Lv 20**：其他職業被動技能
- **Lv 30**：升級 Lv 10 的技能（tier 1 → 2）
- **Lv 40**：升級 Lv 20 的技能（tier 1 → 2）
- **Lv 50**：升級 Lv 10 的技能（tier 2 → 3）
- **Lv 60**：升級 Lv 40 的技能（tier 2 → 3）

---

## 九、正常升級 vs 測試版自動升級的差異

### 9.1 相同之處

#### HP/MP 成長
- **完全相同**：兩者都使用相同的 `rollHpGrowth()` 和 `rollMpGrowth()` 函數
- **計算方式**：每次升級時，HP/MP 成長都基於當前的屬性值計算
- **成長公式**：完全相同

#### 屬性成長
- **公式相同**：兩者都使用相同的屬性成長公式
- **計算方式**：每項屬性隨機 +1 ~ (3 + 等級÷10) + 職業加成
- **配置值**：都使用相同的 `heroGrowthMin` 和 `heroGrowthMax` 配置

#### 職業加成
- **完全相同**：兩者都根據職業類型給予相同的額外屬性加成

### 9.2 關鍵差異

#### 1. HP/MP 恢復（重要差異）

**正常升級**：
- **HP**：只增加最大HP，**不恢復當前HP**
- **MP**：只增加新增的MP數量（例如新增3 MP，當前MP就+3）

**測試版自動升級**：
- **HP**：最後會**補滿到最大HP**
- **MP**：最後會**補滿到最大MP**
- **影響**：測試版升級後，角色會處於滿血滿魔狀態

#### 2. 技能選擇（重要差異）

**正常升級**：
- **技能選擇**：手動選擇（四選一）
- **玩家控制**：玩家可以根據自己的策略選擇技能
- **技能獲得時機**：每兩級一次（Lv 2, 4, 6, 8...）

**測試版自動升級**：
- **技能選擇**：自動選擇第一個可用技能
- **玩家控制**：無，系統自動選擇
- **技能獲得時機**：每兩級一次（Lv 2, 4, 6, 8...）
- **影響**：無法控制技能搭配，可能不是最優選擇

#### 3. 被動技能加成處理

**正常升級**：
- **處理方式**：在學習技能時逐步應用被動技能加成
- **HP/MP 加成**：在學習被動技能時立即應用

**測試版自動升級**：
- **處理方式**：升級完成後會調用 `applyPassiveSkillBonuses()` 函數
- **實際效果**：該函數目前不改變 maxHp/maxMp（因為加成已在學習技能時應用）
- **影響**：理論上無差異，但確保了被動技能加成的正確性

#### 4. 升級流程

**正常升級**：
- **觸發時機**：戰鬥勝利後，經驗值達到升級條件
- **顯示畫面**：顯示能力提升畫面 → 技能選擇畫面 → 同伴升級信息
- **玩家互動**：需要玩家確認和選擇

**測試版自動升級**：
- **觸發時機**：遊戲開始時，自動升級到目標等級
- **顯示畫面**：無（直接完成）
- **玩家互動**：無，完全自動

### 9.3 能力值差異總結

#### 理論上應該相同的能力值
- ✅ **HP 成長值**：相同（因為使用相同的計算函數）
- ✅ **MP 成長值**：相同（因為使用相同的計算函數）
- ✅ **屬性成長值**：相同（因為使用相同的公式和配置）
- ✅ **職業加成**：相同

#### 實際可能不同的地方
- ⚠️ **當前 HP/MP**：測試版會補滿，正常升級不會
- ⚠️ **技能搭配**：測試版自動選擇，可能不是最優搭配
- ⚠️ **被動技能加成**：理論上相同，但處理時機不同

### 9.4 建議

1. **測試版用於快速測試**：適合快速測試遊戲機制和平衡性
2. **正常升級用於正式遊戲**：玩家可以控制技能選擇，體驗更完整
3. **能力值對比**：如果需要對比能力值，應該對比**最大HP/MP**和**屬性值**，而不是當前HP/MP

### 9.5 配置差異

測試版自動升級使用的配置：
- `defaultTargetLevel`：預設目標等級（預設 50）
- `testModeCompanionLevel`：測試模式下同伴加入時的等級（預設 30）
- `testModeAllowAdvancement`：是否允許職業進階（預設 true）

正常升級使用的配置：
- 根據實際遊戲進度逐步升級
- 無固定目標等級
